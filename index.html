<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M·ª´ng 6 th√°ng b√™n nhau ‚ù§Ô∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíñ</text></svg>">

    <script type="module">
        // --- DOM Elements ---
        const sections = {
            letter: null,
            memories: null,
            journey: null,
            timeline: null
        };
        const navButtons = {
            letter: null,
            memories: null,
            journey: null,
            timeline: null
        };
        let lightbox = null, lightboxImage = null, lightboxCaption = null, lightboxDate = null, lightboxLocation = null, lightboxStory = null, closeLightboxButton = null;
        let loveLetterPlaceholder = null, actualLoveLetter = null, letterCountdownEl = null;
        let timelineEventModal = null, timelineEventModalTitle = null, timelineEventModalDate = null, timelineEventModalDescription = null, timelineEventModalImage = null, closeTimelineEventModalButton = null;

        // --- App State ---
        let currentView = 'journey';
        const relationshipStartDate = "2025-01-21";
        let photoMemories = [];
        
        const timelineEventsData = [
            { date: "2025-01-21", title: "Ng√†y M√¨nh Ch√≠nh Th·ª©c V·ªÅ M√≠ Nhau", icon: "üéÅ", description: "M√≥n qu√† ƒë·∫ßu ti√™n ƒë√°nh d·∫•u m·ªôt ch·∫∑ng ƒë∆∞·ªùng m·ªõi c·ªßa hai ƒë·ª©a m√¨nh!", photoId: "p5" },
            { date: "2025-02-14", title: "Valentine ƒê·∫ßu Ti√™n", icon: "üåπ", description: "V·ª£ y√™u ng·ªë ch·ª•p ·∫£nh v·ªõi hoa ch·ªìng t·∫∑ng Valentine", photoId: "p1" },
            { date: "2025-03-08", title: "M√πng 8 Th√°ng 3 ƒê·∫ßu Ti√™n", icon: "üíê", description: "T·∫∑ng hoa cho nh√πa ng·ªë nh√¢n ng√†y Qu·ªëc t·∫ø Ph·ª• n·ªØ. Em l√† ng∆∞·ªùi ph·ª• n·ªØ tuy·ªát v·ªùi nh·∫•t!", photoId: "p923" },
            { date: "2025-03-19", title: "Xem Interstellar & L·∫ßn ƒê·∫ßu üòà", icon: "üòò", description: "Bu·ªïi xem phim Interstellar Imax v√† l·∫ßn ƒë·∫ßu c·ªßa m√¨nh", photoId: "p0" },
            { date: "2025-03-27", title: "Ch·ª•p Photobooth L·∫ßn ƒê·∫ßu", icon: "üì∏", description: "L·∫ßn ƒë·∫ßu ti√™n hai nha ƒë·ªìu ng·ªëc c√πng nhau ƒëi ch·ª•p photobooth", photoId: "p4" },
            { date: "2025-03-27", title: "V√† C≈©ng L√† Ng√†y B·ªã B·∫Øt L·∫ßn ƒê·∫ßu lun", icon: "üòü", description: "Xui gh√™ he :((", photoId: "p56" },
            { date: "2025-04-06", title: "ƒêi ƒÇng C∆∞·ªõi ·ªû Rico Steakhouse", icon: "ü§µüèªüë∞üèª", description: "Ch·ªù ng√†y v·ªÅ chung nh√† <3", photoId: "p99"}, // Ensure p99 exists in photoMemories.json
            { date: "2025-04-20", title: "Sinh Nh·∫≠t ƒê·∫ßu Ti√™n C√πng Em", icon: "üéÇ", description: "C√πng nhau ƒë√≥n nhi·ªÅu sinh nh·∫≠t n·ªØa n√°", photoId: "p9" },
            { date: "2025-05-15", title: "Chuy·∫øn ƒêi Hu·∫ø ƒê·ªãnh M·ªánh, L·∫ßn ƒê·∫ßu ƒêi Du L·ªãch C√πng Nhau", icon: "üöÇ", description: "H∆°i ba ch·∫•m 1 x√≠ nh∆∞ng v·∫´n vui v√¨ c√≥ em =))", photoId: "p92345678" },
            { date: "2025-07-21", title: "K·ª∑ Ni·ªám 6 Th√°ng B√™n Nhau", icon: "üíñ", description: "Ch√∫c m·ª´ng 6 th√°ng b√™n nhauuuuu! Mong r·∫±ng hai ƒë·ª©a m√¨nh s·∫Ω c√≥ th√™m nhi·ªÅu k·ªâ ni·ªám ƒë·∫πp!!!!" }
        ].sort((a, b) => new Date(a.date) - new Date(b.date));

        // --- Data Loading ---
        async function loadPhotoMemories() {
            try {
                const response = await fetch('./photoMemories.json');
                if (!response.ok) {
                    const errorText = `HTTP error! status: ${response.status}. Path: ./photoMemories.json`;
                    console.error(errorText);
                    throw new Error(errorText);
                }
                const data = await response.json();
                photoMemories = data.map((memory, index) => ({ ...memory, internalId: memory.id || `mem-${index}` }));
                console.log("Photo memories loaded:", photoMemories.length);
            } catch (error) {
                console.error("Error loading or parsing photo memories:", error);
                photoMemories = [];
                const container = document.getElementById('photoMemoriesContainer');
                if (container) container.innerHTML = `<p class="text-red-500 text-center py-4 col-span-full">Kh√¥ng th·ªÉ t·∫£i k·ª∑ ni·ªám. L·ªói: ${error.message}</p>`;
            }
            renderPhotoMemories();
        }

        async function loadInitialData() {
            console.log("Loading initial data...");
            await loadPhotoMemories();
            updateJourneyView();
            renderTimelineEvents();
        }

        // --- UI Rendering and Updates ---
        function switchView(viewName) {
            // ... (same as before)
            console.log("Switching to view:", viewName);
            currentView = viewName;
            Object.keys(sections).forEach(key => {
                if (sections[key]) sections[key].classList.toggle('hidden', key !== viewName);
                else console.warn(`Section element for '${key}' not found.`);
            });
            Object.keys(navButtons).forEach(key => {
                if (navButtons[key]) {
                    navButtons[key].classList.toggle('text-pink-500', key === viewName);
                    navButtons[key].classList.toggle('text-gray-500', key !== viewName);
                } else console.warn(`Nav button element for '${key}' not found.`);
            });
            if (viewName === 'journey') updateJourneyView();
            if (viewName === 'memories' && photoMemories.length > 0) renderPhotoMemories();
            if (viewName === 'letter') setupLoveLetterReveal();
        }

        function updateJourneyView() {
            // ... (same as before, with null checks for elements)
            const durationEl = document.getElementById('relationshipDuration');
            const nextAnniversaryEl = document.getElementById('nextAnniversary');
            const nextMonthlyAnniversaryEl = document.getElementById('nextMonthlyAnniversary');
            const fixedDateDisplayEl = document.getElementById('fixedStartDateDisplay');

            if (!durationEl || !nextAnniversaryEl || !nextMonthlyAnniversaryEl || !fixedDateDisplayEl) return;
            
            const startDate = new Date(relationshipStartDate + "T00:00:00");
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            fixedDateDisplayEl.textContent = `M√¨nh ƒë√£ ch√≠nh th·ª©c b√™n nhau t·ª´: ${startDate.toLocaleDateString('vi-VN', { year: 'numeric', month: 'long', day: 'numeric' })}`;

            if (isNaN(startDate.getTime())) {
                 durationEl.innerHTML = '<p class="text-red-500">L·ªói ng√†y b·∫Øt ƒë·∫ßu.</p>';
                 nextAnniversaryEl.textContent = 'L·ªói t√≠nh to√°n';
                 nextMonthlyAnniversaryEl.textContent = 'L·ªói t√≠nh to√°n';
                 return;
            }
            let years = today.getFullYear() - startDate.getFullYear();
            let months = today.getMonth() - startDate.getMonth();
            let days = today.getDate() - startDate.getDate();
            if (days < 0) { months--; days += new Date(today.getFullYear(), today.getMonth(), 0).getDate(); }
            if (months < 0) { years--; months += 12; }
            durationEl.innerHTML = `<p class="text-3xl md:text-4xl font-bold text-pink-600">${years} <span class="text-xl md:text-2xl font-normal text-gray-700">NƒÉm</span></p> <p class="text-3xl md:text-4xl font-bold text-pink-600">${months} <span class="text-xl md:text-2xl font-normal text-gray-700">Th√°ng</span></p> <p class="text-3xl md:text-4xl font-bold text-pink-600">${days} <span class="text-xl md:text-2xl font-normal text-gray-700">Ng√†y</span></p> <p class="mt-2 text-sm text-gray-500">C√πng nhau!</p>`;
            let nextAnniversaryDate = new Date(startDate);
            nextAnniversaryDate.setFullYear(today.getFullYear());
            if (nextAnniversaryDate <= today) nextAnniversaryDate.setFullYear(today.getFullYear() + 1);
            const nextAnniversaryYears = nextAnniversaryDate.getFullYear() - startDate.getFullYear();
            nextAnniversaryEl.textContent = `Ng√†y k·ªâ ni·ªám ${nextAnniversaryYears} nƒÉm: ${nextAnniversaryDate.toLocaleDateString('vi-VN', { month: 'long', day: 'numeric', year: 'numeric' })}`;
            let monthsPassed = (today.getFullYear() - startDate.getFullYear()) * 12 + (today.getMonth() - startDate.getMonth());
            if (today.getDate() < startDate.getDate() && !(today.getFullYear() === startDate.getFullYear() && today.getMonth() === startDate.getMonth())) monthsPassed--;
            if (monthsPassed < 0) monthsPassed = 0;
            let nextMilestoneMonths = monthsPassed + 1;
            let nextMonthlyDate = new Date(startDate.getFullYear(), startDate.getMonth() + nextMilestoneMonths, startDate.getDate());
            nextMonthlyAnniversaryEl.textContent = `C·ªôt m·ªëc ${nextMilestoneMonths} th√°ng: ${nextMonthlyDate.toLocaleDateString('vi-VN', { month: 'long', day: 'numeric', year: (nextMonthlyDate.getFullYear() !== today.getFullYear() ? 'numeric' : undefined) })}`;
        }

        function setupLoveLetterReveal() {
            // ... (same as before, with null checks for elements)
            if (!loveLetterPlaceholder || !actualLoveLetter || !letterCountdownEl) return;
            const startDate = new Date(relationshipStartDate + "T00:00:00");
            if (isNaN(startDate.getTime())) {
                loveLetterPlaceholder.innerHTML = "<p class='text-red-500 text-center'>L·ªói c·∫•u h√¨nh ng√†y.</p>";
                actualLoveLetter.classList.add('hidden'); return;
            }
            const sixMonthAnniversary = new Date(startDate); sixMonthAnniversary.setMonth(startDate.getMonth() + 6);
            const now = new Date();
            if (now >= sixMonthAnniversary) {
                loveLetterPlaceholder.classList.add('hidden'); actualLoveLetter.classList.remove('hidden');
            } else {
                loveLetterPlaceholder.classList.remove('hidden'); actualLoveLetter.classList.add('hidden');
                const daysLeft = Math.ceil((sixMonthAnniversary.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
                if (daysLeft > 1) letterCountdownEl.textContent = `C√≤n t·∫≠n ${daysLeft} ng√†y n·ªØa em m·ªõi ƒë·ªçc ƒë∆∞·ª£c c∆° l√™u l√™u =)) ü•∞`;
                else if (daysLeft === 1) letterCountdownEl.textContent = `Ng√†y mai ƒë·ªçc ƒë∆∞·ª£c √πi em b√© nh·ªõ check nh√° ‚ù§Ô∏è`;
                else letterCountdownEl.textContent = `H√¥m nay l√† ng√†y g√¨iiiiiiiii üíñ`;
            }
        }

        function renderPhotoMemories() {
            // ... (same as before, with null checks for container)
            const container = document.getElementById('photoMemoriesContainer');
            if (!container) return;
            container.innerHTML = '';
            if (photoMemories.length === 0) { /* Message handled by loadPhotoMemories */ return; }
            photoMemories.forEach(memory => {
                const memoryEl = document.createElement('div');
                memoryEl.className = 'bg-white rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden relative group cursor-pointer';
                memoryEl.addEventListener('click', () => openLightbox(memory.internalId));
                const img = document.createElement('img');
                img.src = memory.imageUrl; img.alt = memory.caption || "K·ª∑ ni·ªám";
                img.className = 'w-full h-48 object-cover transition-transform duration-300 group-hover:scale-105';
                img.onerror = () => { img.src = `https://placehold.co/600x400/f8bbd0/4a4a4a?text=Kh%C3%B4ng+t%C3%ACm+th%E1%BA%A5y+%E1%BA%A3nh`; img.alt = "Kh√¥ng t√¨m th·∫•y ·∫£nh"; };
                memoryEl.appendChild(img);
                const captionDiv = document.createElement('div'); captionDiv.className = 'p-3';
                const capText = document.createElement('p'); capText.className = 'text-gray-800 font-semibold truncate'; capText.textContent = memory.caption || "Kh√¥ng c√≥ ch√∫ th√≠ch"; captionDiv.appendChild(capText);
                if (memory.memoryDate) {
                    const dateTextEl = document.createElement('p'); dateTextEl.className = 'text-sm text-gray-500';
                    try {
                        const dateObj = new Date(memory.memoryDate.includes('T') ? memory.memoryDate : memory.memoryDate + "T00:00:00");
                        dateTextEl.textContent = !isNaN(dateObj.getTime()) ? dateObj.toLocaleDateString('vi-VN', { month: 'short', day: 'numeric', year: 'numeric' }) : memory.memoryDate;
                    } catch (e) { dateTextEl.textContent = memory.memoryDate; }
                    captionDiv.appendChild(dateTextEl);
                }
                memoryEl.appendChild(captionDiv); container.appendChild(memoryEl);
            });
        }

        // --- Timeline Functions (REVISED) ---
        function renderTimelineEvents() {
            const container = document.getElementById('timelineEventsContainer');
            if (!container) { console.error("timelineEventsContainer not found."); return; }
            container.innerHTML = '';

            if (timelineEventsData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Ch∆∞a c√≥ s·ª± ki·ªán n√†o trong d√≤ng th·ªùi gian.</p>';
                return;
            }
            
            timelineEventsData.forEach((event, index) => {
                const eventWrapper = document.createElement('div');
                // Each event item is relative for positioning the dot and line
                // pl-8 provides space for the dot and line on the left. py-2 for vertical spacing between events.
                eventWrapper.className = 'relative pl-8 py-3 group cursor-pointer'; 

                // Connecting line: A vertical line on the left side of the content area
                // It should start below the current dot and extend to roughly the next dot's height.
                if (index < timelineEventsData.length - 1) {
                    const lineEl = document.createElement('div');
                    // Positioned to the left (e.g., left-3 or 12px), starting from below the dot
                    // top-5 (20px), assuming dot is also roughly at top-5 or similar
                    // height should be h-full relative to eventWrapper's py-3 if items are tightly packed
                    // More reliably, make it extend full height and use py on parent to control card height
                    lineEl.className = 'absolute left-3 top-5 w-0.5 h-full bg-pink-200 -z-10';
                    eventWrapper.appendChild(lineEl);
                }

                // Dot
                const dotEl = document.createElement('div');
                // top-5 (20px from top of eventWrapper), left-1.5 (6px from left of eventWrapper)
                // Adjust left to visually center on the line or be just to its right
                dotEl.className = 'absolute left-[6px] top-5 w-3 h-3 bg-pink-500 rounded-full border-2 border-white group-hover:bg-pink-700 transition-colors transform';
                eventWrapper.appendChild(dotEl);

                // Content card itself, now to the right of the space created by pl-8 on eventWrapper
                const cardEl = document.createElement('div');
                cardEl.className = 'ml-0 p-4 bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300'; 

                let photoHtml = '';
                if (event.photoId) {
                    const photo = photoMemories.find(p => p.internalId === event.photoId);
                    if (photo && photo.imageUrl) { // Check if photo and imageUrl exist
                        photoHtml = `<img src="${photo.imageUrl}" alt="${event.title || 'K·ª∑ ni·ªám'}" class="mt-3 rounded-md max-h-40 object-cover w-full sm:w-auto transition-transform duration-300 group-hover:scale-105">`;
                    } else {
                        console.warn(`Photo not found or imageUrl missing for photoId: ${event.photoId} in timeline event: "${event.title}"`);
                    }
                }

                cardEl.innerHTML = `
                    <div class="flex items-baseline mb-1">
                        <span class="text-xl sm:text-2xl mr-2 group-hover:scale-110 transition-transform">${event.icon || 'üóìÔ∏è'}</span>
                        <h3 class="text-md sm:text-lg font-semibold text-pink-600 group-hover:text-pink-700 transition-colors">${event.title}</h3>
                    </div>
                    <time class="block mb-2 text-xs sm:text-sm font-normal leading-none text-gray-500">
                        ${new Date(event.date + "T00:00:00").toLocaleDateString('vi-VN', { day: 'numeric', month: 'long', year: 'numeric' })}
                    </time>
                    <p class="text-sm text-gray-700">${event.description}</p>
                    ${photoHtml}
                `;
                eventWrapper.appendChild(cardEl);
                eventWrapper.addEventListener('click', () => openTimelineEventModal(event));
                container.appendChild(eventWrapper);
            });
        }

        function openTimelineEventModal(eventData) {
            console.log("Opening timeline modal for:", eventData.title);
            if (!timelineEventModal || !timelineEventModalTitle || !timelineEventModalDate || !timelineEventModalDescription || !timelineEventModalImage) {
                console.error("Timeline event modal elements not found. Cannot open modal.");
                return;
            }

            timelineEventModalTitle.textContent = eventData.title;
            const eventDate = new Date(eventData.date + "T00:00:00");
            timelineEventModalDate.textContent = eventDate.toLocaleDateString('vi-VN', { day: 'numeric', month: 'long', year: 'numeric' });
            timelineEventModalDescription.textContent = eventData.description;

            const linkedPhoto = eventData.photoId ? photoMemories.find(p => p.internalId === eventData.photoId) : null;
            if (linkedPhoto && linkedPhoto.imageUrl) {
                timelineEventModalImage.src = linkedPhoto.imageUrl;
                timelineEventModalImage.alt = eventData.title;
                timelineEventModalImage.classList.remove('hidden');
            } else {
                timelineEventModalImage.classList.add('hidden');
                timelineEventModalImage.src = "";
                timelineEventModalImage.alt = "";
            }

            timelineEventModal.classList.remove('hidden');
            timelineEventModal.classList.add('flex');
            document.body.style.overflow = 'hidden';
            console.log("Timeline modal displayed.");
        }

        function closeTimelineEventModal() {
            if (!timelineEventModal) return;
            timelineEventModal.classList.add('hidden');
            timelineEventModal.classList.remove('flex');
            document.body.style.overflow = 'auto';
            console.log("Timeline modal closed.");
        }

        // --- Lightbox Functions ---
        function openLightbox(memoryInternalId) {
            // ... (same as before, with null checks)
            const memory = photoMemories.find(m => m.internalId === memoryInternalId);
            if (!memory || !lightbox) return;
            if (lightboxImage) { lightboxImage.src = memory.imageUrl; lightboxImage.alt = memory.caption || "K·ª∑ ni·ªám"; }
            if (lightboxCaption) lightboxCaption.textContent = memory.caption || "Kh√¥ng c√≥ ch√∫ th√≠ch";
            if (lightboxDate) {
                if (memory.memoryDate) {
                    try {
                        const dateObj = new Date(memory.memoryDate.includes('T') ? memory.memoryDate : memory.memoryDate + "T00:00:00");
                        lightboxDate.textContent = !isNaN(dateObj.getTime()) ? `Ng√†y: ${dateObj.toLocaleDateString('vi-VN', { month: 'long', day: 'numeric', year: 'numeric' })}` : `Ng√†y: ${memory.memoryDate}`;
                    } catch (e) { lightboxDate.textContent = `Ng√†y: ${memory.memoryDate}`; }
                } else { lightboxDate.textContent = "Ng√†y: Kh√¥ng r√µ"; }
            }
            if (lightboxLocation) lightboxLocation.textContent = memory.location ? `ƒê·ªãa ƒëi·ªÉm: ${memory.location}` : "ƒê·ªãa ƒëi·ªÉm: Kh√¥ng r√µ";
            if (lightboxStory) lightboxStory.textContent = memory.story || "Ch∆∞a c√≥ c√¢u chuy·ªán cho k·ª∑ ni·ªám n√†y.";
            lightbox.classList.remove('hidden'); lightbox.classList.add('flex'); document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            // ... (same as before)
            if (!lightbox) return;
            lightbox.classList.add('hidden'); lightbox.classList.remove('flex'); document.body.style.overflow = 'auto';
        }

        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM fully loaded and parsed. Initializing page...");

            // Assign all DOM elements first
            sections.letter = document.getElementById('loveLetterSection');
            sections.memories = document.getElementById('memoriesSection');
            sections.journey = document.getElementById('journeySection');
            sections.timeline = document.getElementById('timelineSection'); 
            navButtons.letter = document.getElementById('navLetter');
            navButtons.memories = document.getElementById('navMemories');
            navButtons.journey = document.getElementById('navJourney');
            navButtons.timeline = document.getElementById('navTimeline'); 
            lightbox = document.getElementById('imageLightbox');
            lightboxImage = document.getElementById('lightboxImage');
            lightboxCaption = document.getElementById('lightboxCaption');
            lightboxDate = document.getElementById('lightboxDate');
            lightboxLocation = document.getElementById('lightboxLocation');
            lightboxStory = document.getElementById('lightboxStory');
            closeLightboxButton = document.getElementById('closeLightboxButton');
            loveLetterPlaceholder = document.getElementById('loveLetterPlaceholder');
            actualLoveLetter = document.getElementById('actualLoveLetter');
            letterCountdownEl = document.getElementById('letterCountdown');
            timelineEventModal = document.getElementById('timelineEventModal');
            timelineEventModalTitle = document.getElementById('timelineEventModalTitle');
            timelineEventModalDate = document.getElementById('timelineEventModalDate');
            timelineEventModalDescription = document.getElementById('timelineEventModalDescription');
            timelineEventModalImage = document.getElementById('timelineEventModalImage');
            closeTimelineEventModalButton = document.getElementById('closeTimelineEventModalButton');

            const allCoreElementsPresent = 
                sections.letter && sections.memories && sections.journey && sections.timeline &&
                navButtons.letter && navButtons.memories && navButtons.journey && navButtons.timeline &&
                lightbox && closeLightboxButton && loveLetterPlaceholder && actualLoveLetter && letterCountdownEl &&
                timelineEventModal && timelineEventModalTitle && timelineEventModalDate && 
                timelineEventModalDescription && timelineEventModalImage && closeTimelineEventModalButton;

            if (!allCoreElementsPresent) {
                console.error("CRITICAL FAILURE: One or more core UI elements are missing from the DOM. Page cannot initialize correctly. Please check all element IDs in your HTML and script.");
                document.body.innerHTML = "<p style='color:red; font-size:1.2em; padding:20px; text-align:center;'>L·ªói nghi√™m tr·ªçng: Kh√¥ng t√¨m th·∫•y c√°c th√†nh ph·∫ßn giao di·ªán c·∫ßn thi·∫øt. Trang kh√¥ng th·ªÉ ho·∫°t ƒë·ªông. Vui l√≤ng ki·ªÉm tra m√£ HTML.</p>";
                return; 
            }
            console.log("All core UI elements successfully assigned from DOM.");

            try {
                console.log("Attempting to load initial data...");
                await loadInitialData(); // This includes fetching photos and initial renders
                console.log("Initial data loaded and initial renders complete.");
                
                setupLoveLetterReveal();
                console.log("Love letter reveal setup.");

                switchView(currentView);
                console.log("Initial view switched to:", currentView);

            } catch (e) {
                 console.error("ERROR during page initialization (loadInitialData, setup, or switchView):", e);
                 const journeySection = document.getElementById('journeySection');
                 if (journeySection) {
                    journeySection.innerHTML = `<h2 class="ios-header">L·ªói Kh·ªüi T·∫°o</h2><p class="text-red-500 text-center">Kh√¥ng th·ªÉ t·∫£i ho·∫∑c thi·∫øt l·∫≠p d·ªØ li·ªáu c·∫ßn thi·∫øt cho trang. Vui l√≤ng th·ª≠ l·∫°i sau. Chi ti·∫øt l·ªói: ${e.message}</p>`;
                 } else {
                    document.body.innerHTML = `<p style='color:red; font-size:1.2em; padding:20px; text-align:center;'>L·ªói t·∫£i d·ªØ li·ªáu ho·∫∑c kh·ªüi t·∫°o trang. Vui l√≤ng th·ª≠ l·∫°i sau. Chi ti·∫øt: ${e.message}</p>`;
                 }
                 return; 
            }

            // Setup event listeners only after everything else is ready
            Object.keys(navButtons).forEach(key => {
                if (navButtons[key]) {
                    navButtons[key].addEventListener('click', (event) => {
                        event.preventDefault();
                        switchView(key);
                    });
                }
            });

            if (closeLightboxButton) closeLightboxButton.addEventListener('click', closeLightbox);
            if (lightbox) lightbox.addEventListener('click', (event) => { if (event.target === lightbox) closeLightbox(); });
            if (closeTimelineEventModalButton) closeTimelineEventModalButton.addEventListener('click', closeTimelineEventModal);
            if (timelineEventModal) timelineEventModal.addEventListener('click', (event) => { if (event.target === timelineEventModal) closeTimelineEventModal(); });

            setInterval(() => {
                if (document.hidden) return; 
                updateJourneyView();
                setupLoveLetterReveal();
            }, 60000);
            console.log("Page initialization complete. Event listeners and periodic updates set up.");
        });
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; overscroll-behavior-y: contain; background-color: #fdf2f8; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #f472b6; border-radius: 4px; }
        ::-webkit-scrollbar-track { background-color: #fce7f3; }
        .ios-header { @apply text-2xl font-bold text-pink-700 pb-4 border-b border-pink-200 mb-6 text-center; }
        .content-section { animation: fadeIn 0.5s ease-out; @apply bg-white p-4 sm:p-6 rounded-xl shadow-lg; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        button:active, .group:active { transform: scale(0.97); transition: transform 0.1s ease; }
        .love-letter-text p { @apply mb-4 leading-relaxed text-gray-700; }
        nav .flex > button { @apply w-1/4; }
        #imageLightbox { @apply hidden fixed inset-0 bg-black bg-opacity-80 items-center justify-center p-2 sm:p-4 z-50; }
        .lightbox-content { @apply bg-white rounded-lg shadow-xl p-4 md:p-6 max-w-lg sm:max-w-xl md:max-w-3xl w-full max-h-[90vh] overflow-y-auto flex flex-col md:flex-row gap-4; }
        #lightboxImage { @apply w-full md:w-1/2 h-auto max-h-[50vh] md:max-h-[calc(80vh-4rem)] object-contain rounded-md mb-4 md:mb-0; }
        .lightbox-details { @apply md:w-1/2 flex flex-col py-1 md:py-2; }
        #lightboxCaption { @apply text-lg sm:text-xl font-semibold text-pink-600 mb-2 break-words; }
        #lightboxDate, #lightboxLocation { @apply text-xs sm:text-sm text-gray-600 mb-1; }
        #lightboxStory { @apply text-sm sm:text-base text-gray-700 mt-2 md:mt-3 leading-relaxed flex-grow overflow-y-auto pr-1 md:pr-2; }
        #closeLightboxButton { @apply absolute top-2 right-2 sm:top-3 sm:right-3 text-white bg-black bg-opacity-50 hover:bg-opacity-70 rounded-full p-0 text-2xl sm:text-3xl; width: 30px; height: 30px; sm:width: 36px; sm:height: 36px; display: flex; align-items: center; justify-content: center; line-height: 1; }
        #timelineSection .ios-header { @apply text-pink-700;}
        #timelineEventsContainer { @apply space-y-0; /* Let eventWrapper handle its own spacing/padding */ }
         /* Styling for timeline eventWrapper in renderTimelineEvents JS: 
           eventWrapper.className = 'relative pl-8 py-3 group cursor-pointer'; 
           This creates the space for the dot and line.
        */
        #timelineEventModal { @apply hidden fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-[55]; }
        .timeline-modal-content { @apply bg-white rounded-lg shadow-xl p-5 sm:p-6 max-w-md w-full max-h-[85vh] overflow-y-auto text-center sm:text-left; }
        #timelineEventModalTitle { @apply text-xl sm:text-2xl font-bold text-pink-600 mb-2; }
        #timelineEventModalDate { @apply text-sm text-gray-500 mb-3; }
        #timelineEventModalDescription { @apply text-base text-gray-700 mb-4 leading-relaxed; }
        #timelineEventModalImage { @apply rounded-lg max-h-60 w-auto mx-auto sm:mx-0 mb-4 object-contain; }
        #closeTimelineEventModalButton { @apply mt-4 w-full sm:w-auto bg-pink-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-pink-600 transition-colors focus:outline-none focus:ring-2 focus:ring-pink-300; }
    </style>
</head>
<body class="bg-pink-50 flex flex-col min-h-screen">

    <header class="bg-white shadow-md p-3 sm:p-4 text-center sticky top-0 z-20">
        <h1 class="text-xl sm:text-2xl font-semibold text-pink-600">M·ª´ng 6 th√°ng b√™n nhau ü•∞</h1>
    </header>

    <main id="contentArea" class="flex-grow overflow-y-auto p-3 sm:p-4 md:p-6 space-y-4 sm:space-y-6">
        <section id="journeySection" class="content-section">
            <h2 class="ios-header">H√†nh tr√¨nh c·ªßa hai ƒë·ª©a</h2>
            <div class="space-y-3 sm:space-y-4 text-center">
                <p id="fixedStartDateDisplay" class="text-sm sm:text-md text-gray-700 mb-3 sm:mb-4">ƒêang t·∫£i...</p>
                <div id="relationshipDuration" class="py-4 sm:py-6 bg-pink-50 rounded-lg"> <p class="text-gray-600">ƒêang t√≠nh to√°n...</p> </div>
                <div class="space-y-2 text-xs sm:text-sm text-gray-700">
                    <p id="nextAnniversary" class="p-2 sm:p-3 bg-gray-50 rounded-md">ƒêang t√≠nh to√°n...</p>
                    <p id="nextMonthlyAnniversary" class="p-2 sm:p-3 bg-gray-50 rounded-md">ƒêang t√≠nh to√°n...</p>
                </div>
            </div>
        </section>

        <section id="timelineSection" class="content-section hidden">
            <h2 class="ios-header">D√≤ng th·ªùi gian k·ª∑ ni·ªám</h2>
            <p class="text-center text-sm text-gray-500 mb-4 sm:mb-6">Nh·ªØng c·ªôt m·ªëc ƒë√°ng nh·ªõ c·ªßa ch√∫ng ta.</p>
            <div id="timelineEventsContainer" class="relative"> <p class="text-gray-500 text-center py-4">ƒêang t·∫£i d√≤ng th·ªùi gian...</p> </div>
        </section>

        <section id="loveLetterSection" class="content-section hidden">
            <div id="loveLetterPlaceholder">
                <h2 class="ios-header">Th∆∞ s·∫Øp ƒë∆∞·ª£c m·ªü kh√≥a!</h2>
                <p id="letterCountdown" class="text-center text-gray-600 mt-4 text-md sm:text-lg"></p>
            </div>
            <div id="actualLoveLetter" class="hidden">
                <h2 class="ios-header">‚ù§Ô∏è</h2>
                <div id="loveLetterContent" class="love-letter-text prose max-w-none">
                    <p>‚ù§Ô∏è</p>
                    <p>‚ù§Ô∏è</p>
                    <p>‚ù§Ô∏è</p>
                    <p>‚ù§Ô∏è</p>
                </div>
            </div>
        </section>

        <section id="memoriesSection" class="content-section hidden">
            <h2 class="ios-header">Kho·∫£nh kh·∫Øc ƒë√°ng nh·ªõ</h2>
            <p class="text-center text-sm text-gray-500 mb-4">Nh·ªØng t·∫•m ·∫£nh xinh ƒë√£ ch·ª•p c√πng nhau</p>
            <div id="photoMemoriesContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 sm:gap-4 max-h-[calc(100vh-280px)] sm:max-h-[calc(100vh-250px)] overflow-y-auto p-1">
                 <p class="text-gray-500 text-center py-4 col-span-full">ƒêang t·∫£i k·ª∑ ni·ªám...</p>
            </div>
        </section>
    </main>

    <nav class="bg-white border-t border-gray-200 p-2 sm:p-3 sticky bottom-0 z-20 shadow-top-md">
        <div class="flex justify-around max-w-lg mx-auto">
            <button id="navJourney" class="flex flex-col items-center text-pink-500 p-2 rounded-lg hover:bg-pink-50 transition focus:outline-none focus:bg-pink-100" aria-label="H√†nh tr√¨nh">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/><path d="M21.29 14.7a2.43 2.43 0 0 0-2.65-.52c-.3.12-.57.3-.8.53l-.34.34-.35-.34a2.43 2.43 0 0 0-2.65-.53c-.3.12-.56.3-.79.53-.95.94-1 2.53.2 3.74L17.5 21l3.6-3.55c1.2-1.21 1.14-2.8.19-3.74Z"/></svg>
                <span class="text-xs mt-1">H√†nh tr√¨nh</span>
            </button>
            <button id="navTimeline" class="flex flex-col items-center text-gray-500 p-2 rounded-lg hover:bg-pink-50 transition focus:outline-none focus:bg-pink-100" aria-label="C·ªôt m·ªëc">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M12 6V3"/><path d="M8 3h8"/></svg>
                <span class="text-xs mt-1">C·ªôt m·ªëc</span>
            </button>
            <button id="navLetter" class="flex flex-col items-center text-gray-500 p-2 rounded-lg hover:bg-pink-50 transition focus:outline-none focus:bg-pink-100" aria-label="Th∆∞ g·ª≠i em">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                <span class="text-xs mt-1">Th∆∞ g·ª≠i em</span>
            </button>
            <button id="navMemories" class="flex flex-col items-center text-gray-500 p-2 rounded-lg hover:bg-pink-50 transition focus:outline-none focus:bg-pink-100" aria-label="K·ª∑ ni·ªám">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                <span class="text-xs mt-1">K·ª∑ ni·ªám</span>
            </button>
        </div>
    </nav>

    <div id="imageLightbox" class="hidden">
        <div class="lightbox-content">
            <img id="lightboxImage" src="" alt="K·ª∑ ni·ªám ph√≥ng to" >
            <div class="lightbox-details">
                <h3 id="lightboxCaption"></h3> <p id="lightboxDate"></p> <p id="lightboxLocation"></p>
                <div class="border-t border-gray-200 pt-2 md:pt-3 mt-2 md:mt-3">
                    <h4 class="text-sm font-semibold text-gray-800 mb-1">C√¢u chuy·ªán nh·ªè:</h4> <p id="lightboxStory"></p>
                </div>
            </div>
        </div>
        <button id="closeLightboxButton" aria-label="ƒê√≥ng lightbox">&times;</button>
    </div>

    <div id="timelineEventModal" class="hidden">
        <div class="timeline-modal-content">
            <h3 id="timelineEventModalTitle"></h3> <p id="timelineEventModalDate"></p>
            <img id="timelineEventModalImage" src="" alt="" class="hidden">
            <p id="timelineEventModalDescription"></p>
            <button id="closeTimelineEventModalButton" class="mt-4">ƒê√≥ng</button>
        </div>
    </div>

    <div id="feedbackModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-60 flex items-center justify-center z-[60] p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <h3 id="modalTitle" class="text-xl font-semibold mb-2 text-gray-800"></h3> <p id="modalMessage" class="text-gray-700 mb-4"></p>
            <button id="closeModalButtonFeedback" class="w-full bg-pink-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-pink-600 transition-colors">OK</button>
        </div>
    </div>
</body>
</html>
